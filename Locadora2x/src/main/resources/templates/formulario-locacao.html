<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nova Loca√ß√£o üõí</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow border-0">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">Nova Loca√ß√£o</h4>
                </div>
                <div class="card-body">

                    <form th:action="@{/locacoes/novo}" th:object="${locacaoDto}" method="post">

                        <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
                            <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                        </div>

                        <div th:if="${#fields.hasErrors('filmeId')}" class="alert alert-danger">
                            <p th:errors="*{filmeId}"></p>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Quem vai alugar?</label>
                            <select th:field="*{clienteId}" class="form-select" required>
                                <option value="" disabled selected>Selecione um cliente...</option>
                                <option th:each="cliente : ${clientes}"
                                        th:value="${cliente.id}"
                                        th:text="${cliente.nome}"></option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label class="form-label fw-bold text-muted small"><i class="bi bi-funnel-fill me-1"></i>Filtrar por Categoria</label>
                            <select id="filtroCategoria" class="form-select form-select-sm border-secondary">
                                <option value="">Todas as Categorias</option>
                                <option th:each="cat : ${categorias}"
                                        th:value="${cat.id}"
                                        th:text="${cat.nome}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Qual filme?</label>
                            <select th:field="*{filmeId}" id="filmeSelect" class="form-select" required>
                                <option value="" disabled selected>Selecione um filme...</option>

                                <option th:each="filme : ${filmes}"
                                        th:value="${filme.id}"
                                        th:data-category="${filme.categoria.id}"
                                        th:disabled="${filme.estoque == 0}"
                                        th:text="${filme.titulo} + ' (Estoque: ' + ${filme.estoque} + ')' + (${filme.estoque == 0} ? ' - ESGOTADO' : '')">
                                </option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Data Prevista de Devolu√ß√£o</label>
                            <input type="date" th:field="*{dataDevolucaoPrevista}" class="form-control" required>
                            <div class="form-text">Data combinada para entrega. Atrasos geram multa.</div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning fw-bold">Confirmar Loca√ß√£o</button>
                            <a href="/locacoes" class="btn btn-outline-secondary">Cancelar</a>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DO FILTRO DE CATEGORIAS üß† ---
    document.addEventListener("DOMContentLoaded", function() {
        const filtro = document.getElementById('filtroCategoria');
        const filmesSelect = document.getElementById('filmeSelect');

        // 1. Salva todas as op√ß√µes originais na mem√≥ria
        // (Porque se a gente remover do HTML, perde pra sempre)
        const todasAsOpcoes = Array.from(filmesSelect.options);

        filtro.addEventListener('change', function() {
            const categoriaIdSelecionada = this.value;

            // 2. Limpa o Select de Filmes
            filmesSelect.innerHTML = '';

            // 3. Adiciona de volta apenas quem passou no filtro
            todasAsOpcoes.forEach(opcao => {
                // A op√ß√£o "Selecione um filme..." (que tem value vazio) sempre volta
                if (opcao.value === "") {
                    filmesSelect.appendChild(opcao);
                    return;
                }

                // Pega a categoria guardada no atributo data-category
                const categoriaDoFilme = opcao.getAttribute('data-category');

                // Se o filtro for "Todas" OU a categoria bater, adiciona
                if (categoriaIdSelecionada === "" || categoriaDoFilme === categoriaIdSelecionada) {
                    filmesSelect.appendChild(opcao);
                }
            });

            // Reseta a sele√ß√£o para "Selecione..."
            filmesSelect.value = "";
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>